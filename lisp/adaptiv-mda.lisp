(in-package "CL_USER")

(progn
  (defun make-value-element (date value)
    `(:|Value| (:@ (:|Date| ,(date:format-date date :iso8601 :full nil)))
       ,(if value
            (princ-to-string value)
            "")))
  (defun make-quote-element (quote-type quote-string &optional values)
    `(:|Quote| (:@ (:|QuoteType| ,quote-type)
                   (:|QuoteString| ,quote-string))
       . ,values))

  (defun make-market-data-element (market-data-type &optional quote-elements)
    `(:|MarketData| (:@ (:|MarketDataType| ,market-data-type))
       . ,quote-elements))

  (defun make-market-data-archive-document (archive-name &optional market-data-elements)
    `(:|MarketDataArchive| (:@ (:|ArchiveName| ,archive-name))
       . ,market-data-elements)))


(let* ((archive-name "TEST")
       (tag-names '(archive-name (market-data-type (quote-type (quote-string (date value))))))
       (data `((,archive-name ("Inflation Index"
                               ("Inflation Index"
                                ("EUR CPTFEMU 0"
                                 ("2002-09-30" 95.04)
                                 ("2002-10-31" 95.21)
                                 ("2002-11-30" 95.13)
                                 ("2002-12-31" 95.3)
                                 ("2003-01-31" 95.13)
                                 ("2003-02-28" 95.55)
                                 ("2003-03-31" 95.98)
                                 ("2003-04-30" 96.15)
                                 ("2003-05-31" 96.07)
                                 ("2003-06-30" 96.15)
                                 ("2003-07-31" 95.98)
                                 ("2003-08-31" 96.15)
                                 ("2003-09-30" 96.49)
                                 ("2003-10-31" 96.58)
                                 ("2003-11-30" 96.58)
                                 ("2003-12-31" 96.92)
                                 ("2004-01-31" 96.58)
                                 ("2004-02-29" 96.83)
                                 ("2004-03-31" 97.35)
                                 ("2004-04-30" 97.86)
                                 ("2004-05-31" 98.11)
                                 ("2004-06-30" 98.2)
                                 ("2004-07-31" 97.94)
                                 ("2004-08-31" 98.2)
                                 ("2004-09-30" 98.28)
                                 ("2004-10-31" 98.71)
                                 ("2004-11-30" 98.63)
                                 ("2004-12-31" 98.88)
                                 ("2005-01-31" 98.2)
                                 ("2005-02-28" 98.54)
                                 ("2005-03-31" 99.31)
                                 ("2005-04-30" 99.73)
                                 ("2005-05-31" 99.99)
                                 ("2005-06-30" 100.08)
                                 ("2005-07-31" 99.99)
                                 ("2005-08-31" 100.25)
                                 ("2005-09-30" 100.67)
                                 ("2005-10-31" 100.93)
                                 ("2005-11-30" 100.67)
                                 ("2005-12-31" 101.1)
                                 ("2006-01-31" 100.62)
                                 ("2006-02-28" 100.91)
                                 ("2006-03-31" 101.47)
                                 ("2006-04-30" 102.16)
                                 ("2006-05-31" 102.44)
                                 ("2006-06-30" 102.51)
                                 ("2006-07-31" 102.36)
                                 ("2006-08-31" 102.46)
                                 ("2006-09-30" 102.48)
                                 ("2006-10-31" 102.51)
                                 ("2006-11-30" 102.55)
                                 ("2006-12-31" 102.96)
                                 ("2007-01-31" 102.38)
                                 ("2007-02-28" 102.7)
                                 ("2007-03-31" 103.39)
                                 ("2007-04-30" 104.05)
                                 ("2007-05-31" 104.31)
                                 ("2007-06-30" 104.41)
                                 ("2007-07-31" 104.14)
                                 ("2007-08-31" 104.19)
                                 ("2007-09-30" 104.59)
                                 ("2007-10-31" 105.12)
                                 ("2007-11-30" 105.69)
                                 ("2007-12-31" 106.12)
                                 ("2008-01-31" 105.67)
                                 ("2008-02-29" 106.04)
                                 ("2008-03-31" 107.11)
                                 ("2008-04-30" 107.46)
                                 ("2008-05-31" 108.14)
                                 ("2008-06-30" 108.54)
                                 ("2008-07-31" 108.38)
                                 ("2008-08-31" 108.22)
                                 ("2008-09-30" 108.42)
                                 ("2008-10-31" 108.45)
                                 ("2008-11-30" 107.9)
                                 ("2008-12-31" 107.75)
                                 ("2009-01-31" 106.82)
                                 ("2009-02-28" 107.26)
                                 ("2009-03-31" 107.66)
                                 ("2009-04-30" 108.04)
                                 ("2009-05-31" 108.1)
                                 ("2009-06-30" 108.27)
                                 ("2009-07-31" 107.51)
                                 ("2009-08-31" 107.89)
                                 ("2009-09-30" 107.91)
                                 ("2009-10-31" 108.17)
                                 ("2009-11-30" 108.28)
                                 ("2009-12-31" 108.61)
                                 ("2010-01-31" 107.75)
                                 ("2010-02-28" 108.02)
                                 ("2010-03-31" 109.09)
                                 ("2010-04-30" 109.58)
                                 ("2010-05-31" 109.71)
                                 ("2010-06-30" 109.7)
                                 ("2010-07-31" 109.32)
                                 ("2010-08-31" 109.54)
                                 ("2010-09-30" 109.77)))
                               ("Inflation Rate"
                                ("EUR CPTFEMU 0"
                                 ("2002-09-30"       )
                                 ("2002-10-31"       )
                                 ("2002-11-30"       )
                                 ("2002-12-31"       )
                                 ("2003-01-31"       )
                                 ("2003-02-28"       )
                                 ("2003-03-31"       )
                                 ("2003-04-30"       )
                                 ("2003-05-31"       )
                                 ("2003-06-30"       )
                                 ("2003-07-31"       )
                                 ("2003-08-31"       )
                                 ("2003-09-30"       )
                                 ("2003-10-31"       )
                                 ("2003-11-30"       )
                                 ("2003-12-31"       )
                                 ("2004-01-31"       )
                                 ("2004-02-29"       )
                                 ("2004-03-31"       )
                                 ("2004-04-30"       )
                                 ("2004-05-31"       )
                                 ("2004-06-30" 2.3925)
                                 ("2004-07-31" 2.2075)
                                 ("2004-08-31" 2.15  )
                                 ("2004-09-30" 2.3175)
                                 ("2004-10-31" 2.3975)
                                 ("2004-11-30" 2.3   )
                                 ("2004-12-31" 2.325 )
                                 ("2005-01-31" 2.1725)
                                 ("2005-02-28" 2.035 )
                                 ("2005-03-31" 2.44  )
                                 ("2005-04-30" 2.3575)
                                 ("2005-05-31" 2.345 )
                                 ("2005-06-30" 2.2071)
                                 ("2005-07-31" 2.1723)
                                 ("2005-08-31" 2.2255)
                                 ("2005-09-30" 2.3898)
                                 ("2005-10-31" 2.2892)
                                 ("2005-11-30" 2.1374)
                                 ("2005-12-31" 2.064 )
                                 ("2006-01-31" 2.2594)
                                 ("2006-02-28" 2.1845)
                                 ("2006-03-31" 2.3499)
                                 ("2006-04-30" 2.5453)
                                 ("2006-05-31" 2.6355)
                                 ("2006-06-30" 2.3764)
                                 ("2006-07-31" 2.2771)
                                 ("2006-08-31" 2.5014)
                                 ("2006-09-30" 2.2304)
                                 ("2006-10-31" 2.23  )
                                 ("2006-11-30" 2.365 )
                                 ("2006-12-31" 2.3197)
                                 ("2007-01-31" 2.2325)
                                 ("2007-02-28" 2.2415)
                                 ("2007-03-31" 2.37  )
                                 ("2007-04-30" 2.3675)
                                 ("2007-05-31" 2.335 )
                                 ("2007-06-30" 2.38  )
                                 ("2007-07-31" 2.2775)
                                 ("2007-08-31" 2.11  )
                                 ("2007-09-30" 2.26  )
                                 ("2007-10-31" 2.4375)
                                 ("2007-11-30" 2.5225)
                                 ("2007-12-31" 2.51  )
                                 ("2008-01-31" 2.2575)
                                 ("2008-02-29" 2.4425)
                                 ("2008-03-31" 2.627 )
                                 ("2008-04-30" 2.568 )
                                 ("2008-05-31" 2.684 )
                                 ("2008-06-30" 3.2155)
                                 ("2008-07-31" 2.585 )
                                 ("2008-08-31" 2.455 )
                                 ("2008-09-30" 2.15  )
                                 ("2008-10-31" 1.045 )
                                 ("2008-11-30" 0.2392)
                                 ("2008-12-31" 0.655 )
                                 ("2009-01-31" 1.125 )
                                 ("2009-02-28" 1.04  )
                                 ("2009-03-31" 1.3   )
                                 ("2009-04-30" 1.5409)
                                 ("2009-05-31" 1.68  )
                                 ("2009-06-30" 1.7669)
                                 ("2009-07-31" 1.45  )
                                 ("2009-08-31" 1.6102)
                                 ("2009-09-30" 1.4254)
                                 ("2009-10-31" 1.7822)
                                 ("2009-11-30" 1.7144)
                                 ("2009-12-31" 1.8351)
                                 ("2010-01-31" 1.4062)
                                 ("2010-02-28" 1.6763)
                                 ("2010-03-31" 1.85  )
                                 ("2010-04-30" 1.82  )
                                 ("2010-05-31" 1.725 )
                                 ("2010-06-30" 1.5706)
                                 ("2010-07-31" 1.4739)
                                 ("2010-08-31" 1.42  )
                                 ("2010-09-30" 1.63  ))))
                              ("Implied Inflation"
                               ("Implied Inflation" ,@(mapcar #'(lambda (term rate)
                                                                  (list (format nil "EUR CPTFEMU ~A" term) (list "2010-09-30" rate)))
                                                              '("2y" "3y" "4y" "5y" "7y" "8y" "9y" "10y" "12y" "15y" "20y" "30y")
                                                              '(1.63 1.64 1.66 1.7 1.78 1.81 1.84 1.88 1.89 1.93 1.98 2.13))))))))
  (map nil #'(lambda (dom)
               (s-xml:print-xml dom :input-type :sxml :pretty t :header "<?xml version=\"1.0\" encoding=\"UTF-8\"?>"))
       (loop :for (archive-name . archive-data) :in data
          :collect
          (make-market-data-archive-document
           archive-name
           (loop :for (market-data-type-name . market-data-type-data) :in archive-data
              :collect
              (make-market-data-element
               market-data-type-name
               (loop :for (quote-type . quotes) :in market-data-type-data
                  :nconc (loop :for (quote-string . values) :in quotes
                            :collect
                            (make-quote-element
                             quote-type quote-string
                             (loop :for (date value) :in values
                                :collect
                                (make-value-element
                                 (date::last-working-day
                                  (date::last-day
                                   (date::parse-date date :iso8601))
                                  :sat-sun)
                                 value)))))))))))





